var pokemonNames = [
  {
    "id": 1,
    "text": "Bulbasaur"
  },
  {
    "id": 2,
    "text": "Ivysaur"
  },
  {
    "id": 3,
    "text": "Venusaur"
  },
  {
    "id": 4,
    "text": "Charmander"
  },
  {
    "id": 5,
    "text": "Charmeleon"
  },
  {
    "id": 6,
    "text": "Charizard"
  },
  {
    "id": 7,
    "text": "Squirtle"
  },
  {
    "id": 8,
    "text": "Wartortle"
  },
  {
    "id": 9,
    "text": "Blastoise"
  },
  {
    "id": 10,
    "text": "Caterpie"
  },
  {
    "id": 11,
    "text": "Metapod"
  },
  {
    "id": 12,
    "text": "Butterfree"
  },
  {
    "id": 13,
    "text": "Weedle"
  },
  {
    "id": 14,
    "text": "Kakuna"
  },
  {
    "id": 15,
    "text": "Beedrill"
  },
  {
    "id": 16,
    "text": "Pidgey"
  },
  {
    "id": 17,
    "text": "Pidgeotto"
  },
  {
    "id": 18,
    "text": "Pidgeot"
  },
  {
    "id": 19,
    "text": "Rattata"
  },
  {
    "id": 20,
    "text": "Raticate"
  },
  {
    "id": 21,
    "text": "Spearow"
  },
  {
    "id": 22,
    "text": "Fearow"
  },
  {
    "id": 23,
    "text": "Ekans"
  },
  {
    "id": 24,
    "text": "Arbok"
  },
  {
    "id": 25,
    "text": "Pikachu"
  },
  {
    "id": 26,
    "text": "Raichu"
  },
  {
    "id": 27,
    "text": "Sandshrew"
  },
  {
    "id": 28,
    "text": "Sandslash"
  },
  {
    "id": 29,
    "text": "Nidoran_"
  },
  {
    "id": 30,
    "text": "Nidorina"
  },
  {
    "id": 31,
    "text": "Nidoqueen"
  },
  {
    "id": 32,
    "text": "Nidoran_"
  },
  {
    "id": 33,
    "text": "Nidorino"
  },
  {
    "id": 34,
    "text": "Nidoking"
  },
  {
    "id": 35,
    "text": "Clefairy"
  },
  {
    "id": 36,
    "text": "Clefable"
  },
  {
    "id": 37,
    "text": "Vulpix"
  },
  {
    "id": 38,
    "text": "Ninetales"
  },
  {
    "id": 39,
    "text": "Jigglypuff"
  },
  {
    "id": 40,
    "text": "Wigglytuff"
  },
  {
    "id": 41,
    "text": "Zubat"
  },
  {
    "id": 42,
    "text": "Golbat"
  },
  {
    "id": 43,
    "text": "Oddish"
  },
  {
    "id": 44,
    "text": "Gloom"
  },
  {
    "id": 45,
    "text": "Vileplume"
  },
  {
    "id": 46,
    "text": "Paras"
  },
  {
    "id": 47,
    "text": "Parasect"
  },
  {
    "id": 48,
    "text": "Venonat"
  },
  {
    "id": 49,
    "text": "Venomoth"
  },
  {
    "id": 50,
    "text": "Diglett"
  },
  {
    "id": 51,
    "text": "Dugtrio"
  },
  {
    "id": 52,
    "text": "Meowth"
  },
  {
    "id": 53,
    "text": "Persian"
  },
  {
    "id": 54,
    "text": "Psyduck"
  },
  {
    "id": 55,
    "text": "Golduck"
  },
  {
    "id": 56,
    "text": "Mankey"
  },
  {
    "id": 57,
    "text": "Primeape"
  },
  {
    "id": 58,
    "text": "Growlithe"
  },
  {
    "id": 59,
    "text": "Arcanine"
  },
  {
    "id": 60,
    "text": "Poliwag"
  },
  {
    "id": 61,
    "text": "Poliwhirl"
  },
  {
    "id": 62,
    "text": "Poliwrath"
  },
  {
    "id": 63,
    "text": "Abra"
  },
  {
    "id": 64,
    "text": "Kadabra"
  },
  {
    "id": 65,
    "text": "Alakazam"
  },
  {
    "id": 66,
    "text": "Machop"
  },
  {
    "id": 67,
    "text": "Machoke"
  },
  {
    "id": 68,
    "text": "Machamp"
  },
  {
    "id": 69,
    "text": "Bellsprout"
  },
  {
    "id": 70,
    "text": "Weepinbell"
  },
  {
    "id": 71,
    "text": "Victreebel"
  },
  {
    "id": 72,
    "text": "Tentacool"
  },
  {
    "id": 73,
    "text": "Tentacruel"
  },
  {
    "id": 74,
    "text": "Geodude"
  },
  {
    "id": 75,
    "text": "Graveler"
  },
  {
    "id": 76,
    "text": "Golem"
  },
  {
    "id": 77,
    "text": "Ponyta"
  },
  {
    "id": 78,
    "text": "Rapidash"
  },
  {
    "id": 79,
    "text": "Slowpoke"
  },
  {
    "id": 80,
    "text": "Slowbro"
  },
  {
    "id": 81,
    "text": "Magnemite"
  },
  {
    "id": 82,
    "text": "Magneton"
  },
  {
    "id": 83,
    "text": "Farfetch'd"
  },
  {
    "id": 84,
    "text": "Doduo"
  },
  {
    "id": 85,
    "text": "Dodrio"
  },
  {
    "id": 86,
    "text": "Seel"
  },
  {
    "id": 87,
    "text": "Dewgong"
  },
  {
    "id": 88,
    "text": "Grimer"
  },
  {
    "id": 89,
    "text": "Muk"
  },
  {
    "id": 90,
    "text": "Shellder"
  },
  {
    "id": 91,
    "text": "Cloyster"
  },
  {
    "id": 92,
    "text": "Gastly"
  },
  {
    "id": 93,
    "text": "Haunter"
  },
  {
    "id": 94,
    "text": "Gengar"
  },
  {
    "id": 95,
    "text": "Onix"
  },
  {
    "id": 96,
    "text": "Drowzee"
  },
  {
    "id": 97,
    "text": "Hypno"
  },
  {
    "id": 98,
    "text": "Krabby"
  },
  {
    "id": 99,
    "text": "Kingler"
  },
  {
    "id": 100,
    "text": "Voltorb"
  },
  {
    "id": 101,
    "text": "Electrode"
  },
  {
    "id": 102,
    "text": "Exeggcute"
  },
  {
    "id": 103,
    "text": "Exeggutor"
  },
  {
    "id": 104,
    "text": "Cubone"
  },
  {
    "id": 105,
    "text": "Marowak"
  },
  {
    "id": 106,
    "text": "Hitmonlee"
  },
  {
    "id": 107,
    "text": "Hitmonchan"
  },
  {
    "id": 108,
    "text": "Lickitung"
  },
  {
    "id": 109,
    "text": "Koffing"
  },
  {
    "id": 110,
    "text": "Weezing"
  },
  {
    "id": 111,
    "text": "Rhyhorn"
  },
  {
    "id": 112,
    "text": "Rhydon"
  },
  {
    "id": 113,
    "text": "Chansey"
  },
  {
    "id": 114,
    "text": "Tangela"
  },
  {
    "id": 115,
    "text": "Kangaskhan"
  },
  {
    "id": 116,
    "text": "Horsea"
  },
  {
    "id": 117,
    "text": "Seadra"
  },
  {
    "id": 118,
    "text": "Goldeen"
  },
  {
    "id": 119,
    "text": "Seaking"
  },
  {
    "id": 120,
    "text": "Staryu"
  },
  {
    "id": 121,
    "text": "Starmie"
  },
  {
    "id": 122,
    "text": "Mr. Mime"
  },
  {
    "id": 123,
    "text": "Scyther"
  },
  {
    "id": 124,
    "text": "Jynx"
  },
  {
    "id": 125,
    "text": "Electabuzz"
  },
  {
    "id": 126,
    "text": "Magmar"
  },
  {
    "id": 127,
    "text": "Pinsir"
  },
  {
    "id": 128,
    "text": "Tauros"
  },
  {
    "id": 129,
    "text": "Magikarp"
  },
  {
    "id": 130,
    "text": "Gyarados"
  },
  {
    "id": 131,
    "text": "Lapras"
  },
  {
    "id": 132,
    "text": "Ditto"
  },
  {
    "id": 133,
    "text": "Eevee"
  },
  {
    "id": 134,
    "text": "Vaporeon"
  },
  {
    "id": 135,
    "text": "Jolteon"
  },
  {
    "id": 136,
    "text": "Flareon"
  },
  {
    "id": 137,
    "text": "Porygon"
  },
  {
    "id": 138,
    "text": "Omanyte"
  },
  {
    "id": 139,
    "text": "Omastar"
  },
  {
    "id": 140,
    "text": "Kabuto"
  },
  {
    "id": 141,
    "text": "Kabutops"
  },
  {
    "id": 142,
    "text": "Aerodactyl"
  },
  {
    "id": 143,
    "text": "Snorlax"
  },
  {
    "id": 144,
    "text": "Articuno"
  },
  {
    "id": 145,
    "text": "Zapdos"
  },
  {
    "id": 146,
    "text": "Moltres"
  },
  {
    "id": 147,
    "text": "Dratini"
  },
  {
    "id": 148,
    "text": "Dragonair"
  },
  {
    "id": 149,
    "text": "Dragonite"
  },
  {
    "id": 150,
    "text": "Mewtwo"
  },
  {
    "id": 151,
    "text": "Mew"
  }
]

var commonMarkers = []
var uncommonMarkers = []
var rareMarkers = []
var veryRareMarkers = []
var ultraRareMarkers = []
var cityMarkers = new L.layerGroup()
var gymMarkers = new L.layerGroup()
var gymDetails = {}
var commonID = []
var uncommonID = []
var rareID = []
var veryRareID = []
var ultraRareID = []
var gymIDs = []
var gymMarkersDict = {}
var notifiedPokemon = []
var commonToggle
var uncommonToggle
var rareToggle
var veryRareToggle
var ultraRareToggle
var hidePokemon = []
var notifPokemon = []
var cluster2Pokemon = 11
var notifyIV
var setIconSize
var getLoc
var audio = new Audio('ding.mp3');
var lastTime
var searchInterval
var updateInterval
var gymInterval
var timeInterval
var gymPrestige = [2000, 4000, 8000, 12000, 16000, 20000, 30000, 40000, 50000]
var iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
var mobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)
var markerIcon = L.icon({
  iconUrl: 'images/red.gif',
  iconSize: [26,32]
});
var searchMarker = L.marker([0, 0], {icon: markerIcon, zIndexOffset: -999});

var pokeMoves
var pokeNames
$.getJSON('pokemon.json', function (data) {
  pokeNames = data
})
$.getJSON('moves.json', function (data) {
  pokeMoves = data
})

window.onload = function() {
  getCaptchaStats("getbalance")
  window.setInterval(function() {
    getCaptchaStats("getbalance")
  },60000)
  getCaptchaStats("getstats")
}

//console.log(store.enabled)
if (store.enabled) {
  initializeVariables()
}
else {
  commonToggle = false
  uncommonToggle = false
  rareToggle = true
  veryRareToggle = true
  ultraRareToggle = true
  gymsToggle = true
  $('#commonToggle').bootstrapToggle('off')
  $('#uncommonToggle').bootstrapToggle('off')
  $('#rareToggle').bootstrapToggle('on')
  $('#veryRareToggle').bootstrapToggle('on')
  $('#ultraRareToggle').bootstrapToggle('on')
  $('#gymsToggle').bootstrapToggle('on')
  if (mobile) {
    $('#lowDataToggle').bootstrapToggle('on')
    lowDataToggle = true
  }
  else {
    $('#lowDataToggle').bootstrapToggle('off')
    lowDataToggle = false
  }

}

$.fn.select2.amd.require(['select2/compat/matcher', 'select2/selection/search'], function (oldMatcher, Search) {
  var oldRemoveChoice = Search.prototype.searchRemoveChoice;

  Search.prototype.searchRemoveChoice = function () {
    oldRemoveChoice.apply(this, arguments);
    this.$search.val('');
  };
  $('#pokeHide').select2({
    data: pokemonNames,
    matcher: oldMatcher(matchStart),
    templateResult: formatPoke,
    minimumInputLength: 1
  })
  $("#pokeHide").select2().val(hidePokemon).trigger('change')
  $('#pokeNotify').select2({
    data: pokemonNames,
    matcher: oldMatcher(matchStart),
    templateResult: formatPoke,
    minimumInputLength: 1
  })
  $("#pokeNotify").select2().val(notifPokemon).trigger('change')
})

$('#pokeHide').on('select2:select', function (evt) {
  if ($.inArray(evt.params.data.id, hidePokemon) == -1) {
    hidePokemon.push(parseInt(evt.params.data.id))
    clearAllPokemon()
    search()
  }
  if (store.enabled) {
    store.set('hidePokemon', hidePokemon)
  }
})
$('#pokeHide').on('select2:unselect', function (evt) {
  index = hidePokemon.indexOf(evt.params.data.id)
  hidePokemon.splice(index, 1)
  clearAllPokemon()
  search()
  if (store.enabled) {
    store.set('hidePokemon', hidePokemon)
  }
})

$('#pokeNotify').on('select2:select', function (evt) {
  if ($.inArray(evt.params.data.id, notifPokemon) == -1) {
    notifPokemon.push(parseInt(evt.params.data.id))
  }
  if (store.enabled) {
    store.set('notifPokemon', notifPokemon)
  }
})
$('#pokeNotify').on('select2:unselect', function (evt) {
  index = notifPokemon.indexOf(evt.params.data.id)
  notifPokemon.splice(index, 1)
  if (store.enabled) {
    store.set('notifPokemon', notifPokemon)
  }
})

L.Map = L.Map.extend({
  openPopup: function (popup, latlng, options) {
    if (!(popup instanceof L.Popup)) {
      popup = new L.Popup(options).setContent(popup);
    }

    if (latlng) {
      popup.setLatLng(latlng);
    }

    if (this.hasLayer(popup)) {
      return this;
    }

    // if (this._popup && this._popup.options.autoClose) {
    // 	this.closePopup();
    // }

    this._popup = popup;
    return this.addLayer(popup);
  },
}); /***  end of hack ***/

var style = 'osm-intl';
var server = 'https://maps.wikimedia.org/';
map = L.map('map', {attributionControl: false, minZoom: 4, maxBoundsViscosity: 1, zoomAnimation: false, markerZoomAnimation: false, maxBounds: ([[88, 178], [-88, -178]])});
var mapboxTiles = L.tileLayer(server + style + '/{z}/{x}/{y}.png', {continuousWorld: false, updateWhenZooming: false}).addTo(map)
//var mapboxTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
map.on('load', function (e) {
  if (!iOS) {
    Push.Permission.request();
  }
  // getLocation()
});
// map.on('focus', function(e) {
//   initializeVariables()
// });
map.setView([59.3892144, -100.4054629], 4);
// var mouseOut = true
// var defaultIcon = L.icon({
//   iconUrl: 'https://worldpokemap.com/images/myLocSmall.png',
//   iconSize: [24,35]
// });
// var dracenaMarker = L.marker([-21.487480, -51.536878],{icon:defaultIcon,zIndexOffset:1000})
// dracenaPopup = L.popup().setContent('<center><h3><strong>Donate to Unlock Dracena</strong></h3>' +
// '<h4>$10<br></h4>' +
// '<form action="https://www.paypal.com/cgi-bin/webscr" method="post" target="_top">' +
// '<input type="hidden" name="cmd" value="_s-xclick">' +
// '<input type="hidden" name="hosted_button_id" value="9PFCQ4XBBG7SW">' +
// '<input type="hidden" name="custom" class="userID" value="">' +
// '<input type="image" src="https://www.paypalobjects.com/en_US/i/btn/btn_donate_LG.gif" border="0" name="submit" alt="PayPal - The safer, easier way to pay online!">' +
// '<img alt="" border="0" src="https://www.paypalobjects.com/en_US/i/scr/pixel.gif" width="1" height="1">' +
// '</form>'
// )
// //<input type="hidden" name="custom" class="userID" value=""> <---- ad this to all paypal buttons
// dracenaMarker.bindPopup(dracenaPopup)
// dracenaMarker.on('mouseover', function(e) {
//   dracenaMarker.openPopup()
// })
// dracenaMarker.on('mouseout', function(e) {
//   if (mouseOut) {
//     dracenaMarker.closePopup()
//   }
// })
// dracenaMarker.on('click', function (e) {
//   dracenaMarker.openPopup()
//   map.setView([-21.487480, -51.536878],13)
//   mouseOut = false
// });
// dracenaMarker.on('popupclose', function (e) {
//   if (!mouseOut) {
//     mouseOut = true
//   }
// })
// var pointsOfPoly =   [[[90, -180],
//                        [90, 180],
//                        [-90, 180],
//                        [-90, -180]]
//                      ]
// var cityCenter = L.latLng(52.271446, -113.804089)
// pointsOfPoly.push(calculateShape(cityCenter,5800,5800,5800,5800,45,6))
// var worldOverlay = L.polygon(
//   pointsOfPoly,
//  {
//   fillColor: '#000000',
//   color: '#000000',
//   opacity: 0.8,
//   fillOpacity: 0.1,
//   noClip: true
// })
// cityMarkers.addLayer(dracenaMarker)
// cityMarkers.addLayer(worldOverlay)
// map.addLayer(cityMarkers)

map.zoomControl.setPosition('topright')


function defaultInterval() {
  searchInterval = window.setInterval(search, 5000)
  updateInterval = window.setInterval(update, 5000)
  timeInterval = window.setInterval(updateTime, 1000)
  gymInterval = window.setInterval(function() {
    if (map.getZoom() >= cluster2Pokemon) {
      searchGyms()
    }
  },60000)
}

function clearIntervals() {
  window.clearInterval(searchInterval)
  window.clearInterval(updateInterval)
  window.clearInterval(timeInterval)
  window.clearInterval(gymInterval)
}

function clearTimeouts() {
  window.clearTimeout(searchInterval)
  window.clearTimeout(updateInterval)
  window.clearTimeout(timeInterval)
  window.clearTimeout(gymInterval)
}
defaultInterval();
search();


map.on('dragstart zoomstart', function (e) {
  clearIntervals()
  clearTimeouts()
});

map.on('dragend', function (e) {
  lastTime = null;
  if (map.getZoom() >= cluster2Pokemon) {
    gymInterval = window.setTimeout(function() {
      searchGyms(gymIDs)
    }, 1000)
  }
  searchInterval = window.setTimeout(function () {
    search();
    defaultInterval();
  }, 1000)
  updateInterval = window.setTimeout(update, 1500)
  timeInterval = window.setTimeout(updateTime, 1000)
});

map.on('zoomend', function (e) {
  lastTime = null;
  if (map.getZoom() == cluster2Pokemon - 1 || map.getZoom() == cluster2Pokemon) {
    if (map.getZoom() >= cluster2Pokemon) {
      gymInterval = window.setTimeout(function() {
        searchGyms(gymIDs)
      }, 100)
    }
    searchInterval = window.setTimeout(function () {
      search();
      defaultInterval();
    }, 100)
  }
  else {
    searchInterval = window.setTimeout(function () {
      search();
      defaultInterval();
    }, 500)
    if (map.getZoom() > cluster2Pokemon) {
      gymInterval = window.setTimeout(function() {
        searchGyms(gymIDs)
      }, 500)
    }
  }
  updateInterval = window.setTimeout(update, 2000)
  timeInterval = window.setTimeout(updateTime, 1000)
});


map.on('locationfound', function(e) {
  searchMarker.setLatLng(e.latlng)
  search()
  searchGyms()
})

var sidebar = L.control.sidebar('sidebar').addTo(map);
var common = new L.layerGroup()
var uncommon = new L.layerGroup()
var rare = new L.layerGroup()
var veryRare = new L.layerGroup()
var ultraRare = new L.layerGroup()
var clusters = L.markerClusterGroup({spiderfyOnMaxZoom: false, showCoverageOnHover: false, iconCreateFunction: function (cluster) {
  var markers = cluster.getAllChildMarkers();
  var markerCount = 0;
  markers.forEach(function (m) {
    markerCount = markerCount + m.count;
  });
  return new L.DivIcon({html: '<div class=" clustergroup0 leaflet-marker-icon marker-cluster marker-cluster-medium leaflet-zoom-animated leaflet-clickable" tabindex="0" style="margin-left: -20px; margin-top: -20px; width: 40px; height: 40px; z-index: 233;"><div><span>' + markerCount + '</span></div></div>'});
}
});

map.addLayer(clusters)
map.addLayer(common)
map.addLayer(uncommon)
map.addLayer(rare)
map.addLayer(veryRare)
map.addLayer(ultraRare)
/* This will add all the clusters as returned by the elastic server.*/
function getLocation() {
  map.locate({setView: true, maxZoom: 13, watch: true});
  if (!map.hasLayer(searchMarker)) {
    searchMarker.addTo(map)
  }
  searchMarker.setLatLng(map.getCenter())
  // if ("geolocation" in navigator) {
  //     navigator.geolocation.getCurrentPosition(showPosition);
  // } else {
  //     console.log("Geolocation is not supported by this browser.");
  // }
}
function showPosition(position) {
  map.setView([position.coords.latitude, position.coords.longitude], 13);
  search()
  searchMarker.setLatLng([position.coords.latitude, position.coords.longitude])
  if (!map.hasLayer(searchMarker)) {
    searchMarker.addTo(map)
  }
}
function makeClusters(aggs) {
  if (map.getZoom() < cluster2Pokemon) {
    var markerList = [];
    aggs.forEach(function (agg, index) {
      var center = geohash.decode(agg.key);//elastic return a geohas so need to change it into lat/lon
      var myIcon = L.divIcon({html: '<div class="clustergroup0 leaflet-marker-icon marker-cluster marker-cluster-medium leaflet-zoom-animated leaflet-clickable" tabindex="0" style="margin-left: -20px; margin-top: -20px; width: 40px; height: 40px; z-index: 233;"><div><span>' + agg.doc_count + '</span></div></div>'});
      var marker = L.marker(new L.LatLng(center.latitude, center.longitude), {icon: myIcon, zIndexOffset:1001});
      marker.count = agg.doc_count;
      marker.on('click', function (x) {
        map.setView([x['latlng']['lat'], x['latlng']['lng']], map.getZoom() + 2)
        search()
      })
      //marker.sentiment = agg.sentiment_avg.value;
      markerList.push(marker);
    });
    //console.log(markerList)
    clusters.addLayers(markerList);
  }
}
function makePokemon(pokemon) {
  var markerList = [];
  pokemon.forEach(function (poke, index) {
    var info = poke['_source']
    //console.log(info)
    var location = info['location']
    var pokeID = info['pokemon_id']
    var encID = poke['_id']
    var dt = info['disappearTime']
    var attack = info['iv_attack']
    var defense = info['iv_defense']
    var stamina = info['iv_stamina']
    var move1
    var move2
    if (info['move_1'] != undefined) {
      move1 = pokeMoves[info['move_1']]['name']
      move2 = pokeMoves[info['move_2']]['name']
    }
    var iv = Math.round((attack + defense + stamina) * 1000 / 45.0) / 10
    var name = pokeNames[pokeID]['name']

    if (hidePokemon.includes(pokeID) || Date.parse(dt) < Date.now()) {
      if (commonID.includes(encID)) {
        index = commonID.indexOf(encID)
        commonID.splice(index, 1)
        common.removeLayer(commonMarkers[index])
        commonMarkers.splice(index, 1)
      }
      else if (uncommonID.includes(encID)) {
        index = uncommonID.indexOf(encID)
        uncommonID.splice(index, 1)
        uncommon.removeLayer(uncommonMarkers[index])
        uncommonMarkers.splice(index, 1)
      }
      else if (rareID.includes(encID)) {
        index = rareID.indexOf(encID)
        rareID.splice(index, 1)
        rare.removeLayer(rareMarkers[index])
        rareMarkers.splice(index, 1)
      }
      else if (veryRareID.includes(encID)) {
        index = veryRareID.indexOf(encID)
        veryRareID.splice(index, 1)
        veryRare.removeLayer(veryRareMarkers[index])
        veryRareMarkers.splice(index, 1)
      }
      else if (ultraRareID.includes(encID)) {
        index = ultraRareID.indexOf(encID)
        ultraRareID.splice(index, 1)
        ultraRare.removeLayer(ultraRareMarkers[index])
        ultraRareMarkes.splice(index, 1)
      }
      return true
    }

    if (pokeNames[pokeID]['rarity'] == 'Common' && !commonToggle) {
      return true
    }
    else if (pokeNames[pokeID]['rarity'] == 'Uncommon' && !uncommonToggle) {
      return true
    }
    else if (pokeNames[pokeID]['rarity'] == 'Rare' && !rareToggle) {
      return true
    }
    else if (pokeNames[pokeID]['rarity'] == 'Very Rare' && !veryRareToggle) {
      return true
    }
    else if (pokeNames[pokeID]['rarity'] == 'Ultra Rare' && !ultraRareToggle) {
      return true
    }
    var url
    var size
    if(lowDataToggle) {
       url = 'pixel_icons/' + pokeID + '.png'
       var temp = parseInt($("#iconSize").val()) + 20
       size = [temp,temp*0.75]
    }
    else {
      url = 'images/' + pokeID + '.png'
      size = [$("#iconSize").val(), $("#iconSize").val()]
    }
    var icon = L.icon({
      iconUrl: url,
      iconSize: size
    })
    var popup
    if (attack != null) {
      popup = L.popup()
      .setContent('<strong>' + name + '</strong> - ' + pokeNames[pokeID]['rarity'] +
      '<br><span class="label-countdown" disappears-at=\'' + dt + '\'>' + getTimeRemaining(dt, "string") + '</span>'
      + '</span><br><strong>IV: ' + iv + '% (' + attack + '/' + defense + '/' + stamina + ')</strong><br>'
      + 'Moves: ' + move1 + ' / ' + move2 + '<br>'
      + '<a href="javascript:excludePokemon(' + pokeID + ');">Exclude</a> '
      + '<a href="javascript:notifyPokemon(' + pokeID + ');">Notify</a> '
      + '<a href="javascript:openMapDirections(' + location[1] + ',' + location[0] + ');">Directions</a>'
    )
  }
  else {
    popup = L.popup()
    .setContent('<strong>' + name + '</strong> - ' + pokeNames[pokeID]['rarity'] +
    '<br><span class="label-countdown" disappears-at=\'' + dt + '\'>' + getTimeRemaining(dt, "string") + '</span>'
    + '<br><a href="javascript:excludePokemon(' + pokeID + ');">Exclude</a> '
    + '<a href="javascript:notifyPokemon(' + pokeID + ');">Notify</a>'
    + '<a href="javascript:openMapDirections(' + location[1] + ',' + location[0] + ');">Directions</a>')
  }
  var marker = L.marker([location[1], location[0]], {icon: icon})
  .bindPopup(popup)
  marker['disappearTime'] = moment(dt)
  var mouseOut = true
  marker.on('mouseover', function (e) {
    this.openPopup();
  });
  marker.on('click', function (e) {
    this.openPopup()
    this.stopBouncing();
    mouseOut = false
  });
  marker.on('mouseout', function (e) {
    if (mouseOut) {
      this.closePopup();
    }
  });
  marker.on('popupclose', function (e) {
    if (!mouseOut) {
      mouseOut = true
    }
  })
  if (Date.parse(dt) > Date.now()) {
    if (pokeNames[pokeID]['rarity'] == 'Common' && !commonID.includes(encID) && commonToggle) {
      marker.setZIndexOffset(995)
      marker.addTo(common)
      commonID.push(encID)
      commonMarkers.push(marker)
    }
    else if (pokeNames[pokeID]['rarity'] == 'Uncommon' && !uncommonID.includes(encID) && uncommonToggle) {
      marker.setZIndexOffset(996)
      marker.addTo(uncommon)
      uncommonID.push(encID)
      uncommonMarkers.push(marker)
    }
    else if (pokeNames[pokeID]['rarity'] == 'Rare' && !rareID.includes(encID) && rareToggle) {
      marker.setZIndexOffset(997)
      marker.addTo(rare)
      rareID.push(encID)
      rareMarkers.push(marker)
    }
    else if (pokeNames[pokeID]['rarity'] == 'Very Rare' && !veryRareID.includes(encID) && veryRareToggle) {
      marker.setZIndexOffset(998)
      marker.addTo(veryRare)
      veryRareID.push(encID)
      veryRareMarkers.push(marker)
    }
    else if (pokeNames[pokeID]['rarity'] == 'Ultra Rare' && !ultraRareID.includes(encID) && ultraRareToggle) {
      marker.setZIndexOffset(999)
      marker.addTo(ultraRare)
      ultraRareID.push(encID)
      ultraRareMarkers.push(marker)
    }
  }
  if (notifyIV != "" && iv >= notifyIV && !notifiedPokemon.includes(encID)) {
    notifiedPokemon.push(encID)
    marker.setZIndexOffset(1000)
    if (map.hasLayer(marker)) {
      marker.bounce(1000)
    }
    if (!iOS && Push.Permission.has()) {
      Push.create("High IV Pokémon!", {
        body: "Found a " + iv + "% " + name,
        icon: "pixel_icons/" + pokeID + ".png",
        timeout: 4000,
        vibrate: [200, 100],
        onShow: function () {
          audio.play();
        },
        onClick: function () {
          window.focus()
          map.setView([location[1], location[0]], 15)
        }
      })
    }
  }
  else if (notifPokemon.includes(pokeID) && !notifiedPokemon.includes(encID)) {
    notifiedPokemon.push(encID)
    marker.setZIndexOffset(1000)
    if (map.hasLayer(marker)) {
      marker.bounce(1000)
    }
    if (!iOS && Push.Permission.has()) {
      Push.create("Found a special Pokémon!", {
        body: "Found a " + iv + "% " + name,
        icon: "pixel_icons/" + pokeID + ".png",
        timeout: 4000,
        vibrate: [200, 100],
        onShow: function () {
          audio.play();
        },
        onClick: function () {
          window.focus()
          map.setView([location[1], location[0]], 15)
        }
      })
    }
  }
})
}

function makeGyms(result) {
  gyms = result[0]['hits']['hits']
  gymDet = result[1]['hits']['hits']
  gymDet.forEach(function(gd, index) {
    gymDetails[gd['_id']] = gd['_source']
  })
  gyms.forEach(function (gym, index) {
    var info = gym['_source']
    //console.log(info)
    var gymID = gym['_id']
    var details = details = gymDetails[gymID]
    var teamID = info['team_id']
    var location = info['location']
    var guard = info['guard_pokemon_id']
    var gymPoints = info['gym_points']
    var gymLevel = getGymLevel(gymPoints)
    var prestigeMax
    if (gymLevel == 10) {
      prestigeMax = 52000
    }
    else {
      prestigeMax = gymPrestige[gymLevel-1]
    }
    var iconPic = ""
    var team
    var color
    if (teamID == 0) {
      iconPic = "images/forts/shield/Uncontested.png"
      team = "no one!"
      color = "color:rgba(0,0,0,0.7)"
    }
    else if (teamID == 1) {
      iconPic = "images/forts/shield/Mystic_" + gymLevel + ".png"
      team = "Team Mystic"
      color = "color:rgba(74, 138, 202, .6)"
    }
    else if (teamID == 2) {
      iconPic = "images/forts/shield/Valor_" + gymLevel + ".png"
      team = "Team Valor"
      color = "color:rgba(240, 68, 58, .6)"
    }
    else if (teamID == 3) {
      iconPic = "images/forts/shield/Instinct_" + gymLevel + ".png"
      team = "Team Instinct"
      color = "color:rgba(254, 217, 40, .6)"
    }
    var size = $("#iconSize").val() - 10 + gymLevel/10*20
    var icon = L.icon({
      iconUrl: iconPic,
      iconSize: [size,size]
    })
    var popup = "<center>Gym owned by <b style='" + color + "'>" + team + "</b><br>"
    if (typeof details != "undefined") {
      popup += details['name'] + '<br>'
    }
    popup +=    "Level: " + gymLevel + " | Prestige: " + gymPoints + "/" + prestigeMax + "<br>"
    if (typeof details != "undefined") {
      popup += "<div style='width: 100%;'>"
      var pokemon = details['pokemon']
      pokemon.forEach(function(poke) {
        popup += "<span style='display: inline-block'><span style='display: table;'><img style='display: table-cell;' width='30' height='23' src='pixel_icons/" + poke['pokemon_id'] + ".png'><span class='cp team-" + teamID + "'>" + poke['cp'] + "</span></span></span>  "
      })
      popup += "</div>"
    }
    popup += "Location: " + location[1] + "," + location[0] + "<br>"
    popup += '<a href="javascript:openMapDirections(' + location[1] + ',' + location[0] + ');">Get Directions</a>'
    popup += "</center>"
    leafletPopup = L.popup({className:"gymPopup", maxWidth: 350}).setContent(popup)
    var mouseOut = true
    var marker = L.marker([location[1], location[0]], {icon: icon, zIndexOffset: 0, riseOnHover: true}).bindPopup(leafletPopup)
    marker.on('mouseover', function (e) {
      this.openPopup();
    });
    marker.on('click', function (e) {
      this.openPopup()
      mouseOut = false
    });
    marker.on('mouseout', function (e) {
      if (mouseOut) {
        this.closePopup();
      }
    });
    marker.on('popupclose', function (e) {
      if (!mouseOut) {
        mouseOut = true
      }
    })
    if (typeof gymMarkersDict[gymID] != "undefined") {
      map.removeLayer(gymMarkers[gymID])
      gymMarkers.removeLayer(gymMarkers[gymID])
      gymMarkersDict[gymID] = marker
      marker.addTo(gymMarkers)
    }
    else {
      gymIDs.push(gymID)
      gymMarkersDict[gymID] = marker
      marker.addTo(gymMarkers)
    }
  })
  map.addLayer(gymMarkers)
}

function update() {
  for (marker in commonMarkers) {
    if (moment(commonMarkers[marker]['disappearTime']).isBefore(moment())) {
      common.removeLayer(commonMarkers[marker])
      commonMarkers.splice(marker, 1)
      commonID.splice(marker, 1)
    }
  }
  for (marker in uncommonMarkers) {
    if (moment(uncommonMarkers[marker]['disappearTime']).isBefore(moment())) {
      uncommon.removeLayer(uncommonMarkers[marker])
      uncommonMarkers.splice(marker, 1)
      uncommonID.splice(marker, 1)
    }
  }
  for (marker in rareMarkers) {
    if (moment(rareMarkers[marker]['disappearTime']).isBefore(moment())) {
      rare.removeLayer(rareMarkers[marker])
      rareMarkers.splice(marker, 1)
      rareID.splice(marker, 1)
    }
  }
  for (marker in veryRareMarkers) {
    if (moment(veryRareMarkers[marker]['disappearTime']).isBefore(moment())) {
      veryRare.removeLayer(veryRareMarkers[marker])
      veryRareMarkers.splice(marker, 1)
      veryRareID.splice(marker, 1)
    }
  }
  for (marker in ultraRareMarkers) {
    if (moment(ultraRareMarkers[marker]['disappearTime']).isBefore(moment())) {
      ultraRare.removeLayer(ultraRareMarkers[marker])
      ultraRareMarkers.splice(marker, 1)
      ultraRareID.splice(marker, 1)
    }
  }
}

function updateTime() {
  $(".label-countdown").each(function (index, element) {
    $(element).text(getTimeRemaining(element.getAttribute('disappears-at'), "string"))
  })
}

function getGymLevel (points) {
  var level = 1
  while (points >= gymPrestige[level - 1]) {
    level++
  }

  return level
}

function search() {
  var b = map.getBounds();
  var b1 = {
    "nwlat": b.getNorthWest().lat % 90,
    "nwlon": b.getNorthWest().lng % 180,
    "selat": b.getSouthEast().lat % 90,
    "selon": b.getSouthEast().lng % 180
  }
  //Get the zoom level
  var zoom = 3;
  if (map.getZoom() >= 5 && map.getZoom() <= 8) {
    zoom = 4;
  }
  else if (map.getZoom() >= 9 && map.getZoom() <= 11) {
    zoom = 5;
  }
  else if (map.getZoom() >= 12 && map.getZoom() <= 14) {
    zoom = 6;
  }
  else if (map.getZoom() >= 15 && map.getZoom() <= 17) {
    zoom = 7;
  }
  else if (map.getZoom() >= 18) {
    zoom = 8;
  }
  var dataObj = {
    northWestLat: b1.nwlat,
    northWestLng: b1.nwlon,
    southEastLat: b1.selat,
    southEastLng: b1.selon,
    zoom: zoom
  }
  if (!commonToggle) {
    dataObj['common'] = false
  }
  if (!uncommonToggle) {
    dataObj['uncommon'] = false
  }
  if (!rareToggle) {
    dataObj['rare'] = false
  }
  if (!veryRareToggle) {
    dataObj['veryrare'] = false
  }
  if (!ultraRareToggle) {
    dataObj['ultrarare'] = false
  }
  if (map.getZoom() < cluster2Pokemon) {
    // map.removeLayer(cityMarkers)
    $.ajax({
      type: "POST",
      url: "clusterGrab.php",
      data: dataObj,
      cache: false,
      success: function (resp) {
        //console.log(resp)
        if (resp.startsWith("Error:")) {
          console.log(resp)
        }
        else {
          clearAllPokemon()
          clearAllGyms()
          var result = JSON.parse(resp)
          makeClusters(result.aggregations.zoom.buckets)
        }
      }
    })
  }
  else {
    var encID = []
    for (id in commonID) {
      encID.push(commonID[id])
      //dataString += "&encID[]=" + commonID[id]
    }
    for (id in uncommonID) {
      encID.push(uncommonID[id])
      //dataString += "&encID[]=" + uncommonID[id]
    }
    for (id in rareID) {
      encID.push(rareID[id])
      //dataString += "&encID[]=" + rareID[id]
    }
    for (id in veryRareID) {
      encID.push(veryRareID[id])
      //dataString += "&encID[]=" + veryRareID[id]
    }
    for (id in ultraRareID) {
      encID.push(ultraRareID[id])
      //dataString += "&encID[]=" + ultraRareID[id]
    }
    dataObj['encID'] = encID
    $.ajax({
      type: "POST",
      url: "pokeGrab.php",
      data: dataObj,
      cache: false,
      success: function (resp) {
        if (resp.startsWith("Error:")) {
          console.log(resp)
        }
        else
        {
          clusters.clearLayers();
          // common.clearLayers();
          var result = JSON.parse(resp)
          makePokemon(result[0]['hits']['hits'])
          // if (result[0]['hits']['total'] > 1000) {
          //   window.setTimeout(search(),500)
          // }
        }
      }
    })
  }
}

function searchGyms(gymIDArray) {
  if (gymsToggle) {
    var b = map.getBounds();
    var b1 = {
      "nwlat": b.getNorthWest().lat % 90,
      "nwlon": b.getNorthWest().lng % 180,
      "selat": b.getSouthEast().lat % 90,
      "selon": b.getSouthEast().lng % 180
    }
    //Get the zoom level
    var zoom = 3;
    if (map.getZoom() >= 5 && map.getZoom() <= 8) {
      zoom = 4;
    }
    else if (map.getZoom() >= 9 && map.getZoom() <= 11) {
      zoom = 5;
    }
    else if (map.getZoom() >= 12 && map.getZoom() <= 14) {
      zoom = 6;
    }
    else if (map.getZoom() >= 15 && map.getZoom() <= 17) {
      zoom = 7;
    }
    else if (map.getZoom() >= 18) {
      zoom = 8;
    }
    var dataObj = {
      northWestLat: b1.nwlat,
      northWestLng: b1.nwlon,
      southEastLat: b1.selat,
      southEastLng: b1.selon,
      zoom: zoom
    }
    if (lastTime != null) {
      dataObj['time'] = lastTime
    }
    if (typeof gymIDArray != "undefined") {
      dataObj['gymIDs'] = gymIDArray
    }
    $.ajax({
      type: "POST",
      url: "gymGrab.php",
      data: dataObj,
      cache: false,
      success: function (resp) {
        var result = JSON.parse(resp)
        makeGyms(result)
        lastTime = result['time']
      }
    })
  }
  else {
    console.log("called gymsGrab with gymsToggle set to false")
  }

}

function pad(n) {
  return (n < 10) ? ("0" + n) : n;
}

function matchStart(term, text) {
  if (text.toUpperCase().indexOf(term.toUpperCase()) == 0) {
    return true;
  }

  return false;
}

function clearAllPokemon() {
  clusters.clearLayers()
  common.clearLayers()
  uncommon.clearLayers()
  rare.clearLayers()
  veryRare.clearLayers()
  ultraRare.clearLayers()
  commonMarkers = []
  uncommonMarkers = []
  rareMarkers = []
  veryRareMarkers = []
  ultraRareMarkers = []
  commonID = []
  uncommonID = []
  rareID = []
  veryRareID = []
  ultraRareID = []
}

function clearAllGyms() {
  lastTime = null;
  gymMarkers.clearLayers()
  gymMarkersDict = {}
  gymIDs = []
}

function formatPoke(poke) {
  console.log(poke)
  if (!poke.id) {
    return poke.text;
  }
  var $poke = $(
    '<span><img src="pixel_icons/' + poke.id + '.png" class="img-flag" /> ' + poke.text + '</span>'
  );
  return $poke;
}
;


function calculateShape(point,r1,r2,r3,r4,rotation,vertexCount,  colour,weight,opacity,opts,tilt) {
  var rot = -rotation*Math.PI/180;
  var points = [];
  var latConv = point.distanceTo(new L.latLng(point.lat+0.1,point.lng))*10;
  var lngConv = point.distanceTo(new L.latLng(point.lat,point.lng+0.1))*10;
  var step = (360/vertexCount)||10;

  var flop = -1;
  if (tilt) {
    var I1=180/vertexCount;
  } else {
    var  I1=0;
  }
  for(var i=I1; i<=360.001+I1; i+=step) {
    var r1a = flop?r1:r3;
    var r2a = flop?r2:r4;
    flop = -1-flop;
    var y = r1a * Math.cos(i * Math.PI/180);
    var x = r2a * Math.sin(i * Math.PI/180);
    var lng = (x*Math.cos(rot)-y*Math.sin(rot))/lngConv;
    var lat = (y*Math.cos(rot)+x*Math.sin(rot))/latConv;

    points.push([point.lat+lat,point.lng+lng]);
  }
  return (points)
}


function excludePokemon(num) {
  hidePokemon.push(num)
  $("#pokeHide").select2().val(hidePokemon).trigger('change')
  store.set('hidePokemon', hidePokemon)
  clearAllPokemon()
  search()
}

function notifyPokemon(num) {
  notifPokemon.push(num)
  $("#pokeNotify").select2().val(notifPokemon).trigger('change')
  store.set('notifPokemon', notifPokemon)
}

function removePokemon(encID) {
  if ($.inArray(commonID, encID)) {
    index = commonID.indexOf(encID)
    commonID.splice(index, 1)
    common.removeLayer(commonMarkers[index])
    commonMarkers.splice(index, 1)
  }
  else if ($.inArray(uncommonID, encID)) {
    index = uncommonID.indexOf(encID)
    uncommonID.splice(index, 1)
    uncommon.removeLayer(uncommonMarkers[index])
    uncommonMarkers.splice(index, 1)
  }
  else if ($.inArray(rareID, encID)) {
    index = rareID.indexOf(encID)
    rareID.splice(index, 1)
    rare.removeLayer(rareMarkers[index])
    rareMarkers.splice(index, 1)
  }
  else if ($.inArray(veryRareID, encID)) {
    index = veryRareID.indexOf(encID)
    veryRareID.splice(index, 1)
    veryRare.removeLayer(veryRareMarkers[index])
    veryRareMarkers.splice(index, 1)
  }
  else if ($.inArray(ultraRareID, encID)) {
    index = ultraRareID.indexOf(encID)
    ultraRareID.splice(index, 1)
    ultraRare.removeLayer(ultraRareMarkers[index])
    ultraRareMarkers.splice(index, 1)
  }
}

function getTimeRemaining(endtime, returnType) {
  // console.log(new Date(endtime))
  // console.log(new Date())
  var t = Date.parse(endtime) - Date.parse(new Date());
  var seconds = Math.floor((t / 1000) % 60);
  var minutes = Math.floor((t / 1000 / 60) % 60);
  var hours = Math.floor((t / (1000 * 60 * 60)) % 24);
  var days = Math.floor(t / (1000 * 60 * 60 * 24));
  if (returnType == "string") {
    return 'Disappears in ' + pad(minutes) + 'm' + pad(seconds) + 's'
  }
  else if (returnType == "digits") {
    return {
      'total': t,
      'days': days,
      'hours': hours,
      'minutes': minutes,
      'seconds': seconds
    };
  }
}

function openMapDirections(lat, lng) { // eslint-disable-line no-unused-vars
  map.locate()
  window.setTimeout(function() {
    var myLocation = searchMarker.getLatLng()
    var url = 'https://www.google.com/maps/dir/' + myLocation.lat + ',' + myLocation.lng + '/' + lat + ',' + lng
    window.open(url, '_blank')
  },1000)
}

function initializeVariables() {
  if (store.get('iconSize') != undefined) {
    $("#iconSize").val(store.get('iconSize'))
    $("#sizeVal").text(store.get('iconSize'))
  }
  if (store.get('notifyIV') == undefined) {
    store.set('notifyIV', "")
  }
  else {
    notifyIV = store.get('notifyIV')
    $("#notifyIV").val(notifyIV)
  }
  if (store.get('hidePokemon') == undefined) {
    store.set('hidePokemon', hidePokemon)
  }
  else {
    hidePokemon = store.get('hidePokemon')
  }
  if (store.get('notifPokemon') != undefined) {
    notifPokemon = store.get('notifPokemon')
  }
  if (store.get('gyms') == undefined) {
    $('#gymsToggle').bootstrapToggle('on')
    store.set('gyms', true)
    gymsToggle = true
  }
  else {
    gymsToggle = Boolean(store.get('gyms'))
    if (gymsToggle) {
      $('#gymsToggle').bootstrapToggle('on')
    }
    else {
      $('#gymsToggle').bootstrapToggle('off')
    }
  }
  if (store.get('lowData') == undefined) {
    if (mobile) {
      $('#lowDataToggle').bootstrapToggle('on')
      store.set('lowData', true)
      lowDataToggle = true
    }
    else {
      $('#lowDataToggle').bootstrapToggle('off')
      store.set('lowData', false)
      lowDataToggle = false
    }
  }
  else {
    lowDataToggle = Boolean(store.get('lowData'))
    if (lowDataToggle) {
      $('#lowDataToggle').bootstrapToggle('on')
    }
    else {
      $('#lowDataToggle').bootstrapToggle('off')
    }
  }
  if (store.get('common') == undefined) {
    $('#rareToggle').bootstrapToggle('off')
    store.set('common', false)
    commonToggle = false
  }
  else {
    commonToggle = Boolean(store.get('common'))
    if (commonToggle) {
      $('#commonToggle').bootstrapToggle('on')
    }
    else {
      $('#commonToggle').bootstrapToggle('off')
    }
  }
  if (store.get('uncommon') == undefined) {
    $('#rareToggle').bootstrapToggle('off')
    store.set('uncommon', false)
    uncommonToggle = false
  }
  else {
    uncommonToggle = Boolean(store.get('uncommon'))
    if (uncommonToggle) {
      $('#uncommonToggle').bootstrapToggle('on')
    }
    else {
      $('#uncommonToggle').bootstrapToggle('off')
    }
  }
  if (store.get('rare') == undefined) {
    $('#rareToggle').bootstrapToggle('on')
    store.set('rare', true)
    rareToggle = true
  }
  else {
    rareToggle = Boolean(store.get('rare'))
    if (rareToggle) {
      $('#rareToggle').bootstrapToggle('on')
    }
    else {
      $('#rareToggle').bootstrapToggle('off')
    }
  }
  if (store.get('veryrare') == undefined) {
    $('#veryRareToggle').bootstrapToggle('on')
    store.set('veryrare', true)
    veryRareToggle = true
  }
  else {
    veryRareToggle = Boolean(store.get('veryrare'))
    if (veryRareToggle) {
      $('#veryRareToggle').bootstrapToggle('on')
    }
    else {
      $('#veryRareToggle').bootstrapToggle('off')
    }
  }
  if (store.get('ultrarare') == undefined) {
    $('#ultraRareToggle').bootstrapToggle('on')
    store.set('ultrarare', true)
    ultraRareToggle = true
  }
  else {
    ultraRareToggle = Boolean(store.get('ultrarare'))
    if (ultraRareToggle) {
      $('#ultraRareToggle').bootstrapToggle('on')
    }
    else {
      $('#ultraRareToggle').bootstrapToggle('off')
    }
  }
}

function sleep(milliseconds) {
  var start = new Date().getTime();
  for (var i = 0; i < 1e7; i++) {
    if ((new Date().getTime() - start) > milliseconds) {
      break;
    }
  }
}

function getCaptchaStats(action) {
  if (action == "getstats") {
    var today = new Date();
    var dd = today.getDate()
    var mm = today.getMonth() + 1
    var yy = today.getFullYear()
    action += "&date=" + yy + "-" + pad(mm) + "-" + dd
  }
  $.ajax({
    type: "POST",
    url: "captchaStatsGrab.php",
    data: "action=" + action,
    cache: false,
    success: function (resp) {
      //console.log(resp)
      if (action == "getbalance") {
        $(".captchaAmount").each(function (index, element) {
          $(element).text(parseFloat(resp.replace(/['"]+/g, '')).toFixed(2))
        })
      }
      else if (action.includes("getstats")) {
        jsonResp = xml2json(resp)['response']['stats']
        var total = 0
        for (num in jsonResp) {
          total += parseFloat(jsonResp[num]['money'].replace('>',''))
        }
        $(".captchaRate").each(function (index, element) {
          $(element).text(total.toFixed(2))
        })
      }
      else {
        console.log(resp)
      }
    }
  })
}

$('#location').on('click', function () {
  if ($('#location').parent('li').hasClass('active')) {
    map.stopLocate()
    $('#location').parent('li').removeClass('active')
  }
  else {
    getLocation()
    $('#location').parent('li').addClass('active')
  }
})

$('#notifyIV').change(function () {
  notifyIV = $('#notifyIV').val()
  if (store.enabled) {
    store.set('notifyIV', notifyIV)
  }
})
$('#gymsToggle').change(function () {
  gymsToggle = !gymsToggle
  if (store.enabled) {
    store.set('gyms', gymsToggle)
  }
  clearAllGyms()
  if (gymsToggle && map.getZoom() >= cluster2Pokemon) {
    searchGyms()
  }
})
$('#lowDataToggle').change(function () {
  lowDataToggle = !lowDataToggle
  if (store.enabled) {
    store.set('lowData', lowDataToggle)
  }
  clearAllPokemon()
  search()
})
$('#commonToggle').change(function () {
  commonToggle = !commonToggle
  if (store.enabled) {
    store.set('common', commonToggle)
  }
  common.clearLayers();
  commonMarkers = []
  commonID = []
  search()
})
$('#uncommonToggle').change(function () {
  uncommonToggle = !uncommonToggle
  if (store.enabled) {
    store.set('uncommon', uncommonToggle)
  }
  uncommon.clearLayers();
  uncommonMarkers = []
  uncommonID = []
  search()
})
$('#rareToggle').change(function () {
  rareToggle = !rareToggle
  if (store.enabled) {
    store.set('rare', rareToggle)
  }
  rare.clearLayers();
  rareMarkers = []
  rareID = []
  search()
})
$('#veryRareToggle').change(function () {
  veryRareToggle = !veryRareToggle
  if (store.enabled) {
    store.set('veryrare', veryRareToggle)
  }
  veryRare.clearLayers()
  veryRareMarkers = []
  veryRareID = []
  search()
})
$('#ultraRareToggle').change(function () {
  ultraRareToggle = !ultraRareToggle
  if (store.enabled) {
    store.set('ultrarare', ultraRareToggle)
  }
  ultraRare.clearLayers();
  ultraRareMarkers = []
  ultraRareID = []
  search()
})
$('#iconSize').change(function () {
  val = $("#iconSize").val()
  $("#sizeVal").text(val)
  lastTime = null
  clearAllPokemon()
  clearAllGyms()
  search()
  searchGyms()
  if (store.enabled) {
    store.set('iconSize', val)
  }
})

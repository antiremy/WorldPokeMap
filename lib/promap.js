var pokemonNames = [
  {
    "id": 1,
    "text": "Bulbasaur"
  },
  {
    "id": 2,
    "text": "Ivysaur"
  },
  {
    "id": 3,
    "text": "Venusaur"
  },
  {
    "id": 4,
    "text": "Charmander"
  },
  {
    "id": 5,
    "text": "Charmeleon"
  },
  {
    "id": 6,
    "text": "Charizard"
  },
  {
    "id": 7,
    "text": "Squirtle"
  },
  {
    "id": 8,
    "text": "Wartortle"
  },
  {
    "id": 9,
    "text": "Blastoise"
  },
  {
    "id": 10,
    "text": "Caterpie"
  },
  {
    "id": 11,
    "text": "Metapod"
  },
  {
    "id": 12,
    "text": "Butterfree"
  },
  {
    "id": 13,
    "text": "Weedle"
  },
  {
    "id": 14,
    "text": "Kakuna"
  },
  {
    "id": 15,
    "text": "Beedrill"
  },
  {
    "id": 16,
    "text": "Pidgey"
  },
  {
    "id": 17,
    "text": "Pidgeotto"
  },
  {
    "id": 18,
    "text": "Pidgeot"
  },
  {
    "id": 19,
    "text": "Rattata"
  },
  {
    "id": 20,
    "text": "Raticate"
  },
  {
    "id": 21,
    "text": "Spearow"
  },
  {
    "id": 22,
    "text": "Fearow"
  },
  {
    "id": 23,
    "text": "Ekans"
  },
  {
    "id": 24,
    "text": "Arbok"
  },
  {
    "id": 25,
    "text": "Pikachu"
  },
  {
    "id": 26,
    "text": "Raichu"
  },
  {
    "id": 27,
    "text": "Sandshrew"
  },
  {
    "id": 28,
    "text": "Sandslash"
  },
  {
    "id": 29,
    "text": "Nidoran_"
  },
  {
    "id": 30,
    "text": "Nidorina"
  },
  {
    "id": 31,
    "text": "Nidoqueen"
  },
  {
    "id": 32,
    "text": "Nidoran_"
  },
  {
    "id": 33,
    "text": "Nidorino"
  },
  {
    "id": 34,
    "text": "Nidoking"
  },
  {
    "id": 35,
    "text": "Clefairy"
  },
  {
    "id": 36,
    "text": "Clefable"
  },
  {
    "id": 37,
    "text": "Vulpix"
  },
  {
    "id": 38,
    "text": "Ninetales"
  },
  {
    "id": 39,
    "text": "Jigglypuff"
  },
  {
    "id": 40,
    "text": "Wigglytuff"
  },
  {
    "id": 41,
    "text": "Zubat"
  },
  {
    "id": 42,
    "text": "Golbat"
  },
  {
    "id": 43,
    "text": "Oddish"
  },
  {
    "id": 44,
    "text": "Gloom"
  },
  {
    "id": 45,
    "text": "Vileplume"
  },
  {
    "id": 46,
    "text": "Paras"
  },
  {
    "id": 47,
    "text": "Parasect"
  },
  {
    "id": 48,
    "text": "Venonat"
  },
  {
    "id": 49,
    "text": "Venomoth"
  },
  {
    "id": 50,
    "text": "Diglett"
  },
  {
    "id": 51,
    "text": "Dugtrio"
  },
  {
    "id": 52,
    "text": "Meowth"
  },
  {
    "id": 53,
    "text": "Persian"
  },
  {
    "id": 54,
    "text": "Psyduck"
  },
  {
    "id": 55,
    "text": "Golduck"
  },
  {
    "id": 56,
    "text": "Mankey"
  },
  {
    "id": 57,
    "text": "Primeape"
  },
  {
    "id": 58,
    "text": "Growlithe"
  },
  {
    "id": 59,
    "text": "Arcanine"
  },
  {
    "id": 60,
    "text": "Poliwag"
  },
  {
    "id": 61,
    "text": "Poliwhirl"
  },
  {
    "id": 62,
    "text": "Poliwrath"
  },
  {
    "id": 63,
    "text": "Abra"
  },
  {
    "id": 64,
    "text": "Kadabra"
  },
  {
    "id": 65,
    "text": "Alakazam"
  },
  {
    "id": 66,
    "text": "Machop"
  },
  {
    "id": 67,
    "text": "Machoke"
  },
  {
    "id": 68,
    "text": "Machamp"
  },
  {
    "id": 69,
    "text": "Bellsprout"
  },
  {
    "id": 70,
    "text": "Weepinbell"
  },
  {
    "id": 71,
    "text": "Victreebel"
  },
  {
    "id": 72,
    "text": "Tentacool"
  },
  {
    "id": 73,
    "text": "Tentacruel"
  },
  {
    "id": 74,
    "text": "Geodude"
  },
  {
    "id": 75,
    "text": "Graveler"
  },
  {
    "id": 76,
    "text": "Golem"
  },
  {
    "id": 77,
    "text": "Ponyta"
  },
  {
    "id": 78,
    "text": "Rapidash"
  },
  {
    "id": 79,
    "text": "Slowpoke"
  },
  {
    "id": 80,
    "text": "Slowbro"
  },
  {
    "id": 81,
    "text": "Magnemite"
  },
  {
    "id": 82,
    "text": "Magneton"
  },
  {
    "id": 83,
    "text": "Farfetch'd"
  },
  {
    "id": 84,
    "text": "Doduo"
  },
  {
    "id": 85,
    "text": "Dodrio"
  },
  {
    "id": 86,
    "text": "Seel"
  },
  {
    "id": 87,
    "text": "Dewgong"
  },
  {
    "id": 88,
    "text": "Grimer"
  },
  {
    "id": 89,
    "text": "Muk"
  },
  {
    "id": 90,
    "text": "Shellder"
  },
  {
    "id": 91,
    "text": "Cloyster"
  },
  {
    "id": 92,
    "text": "Gastly"
  },
  {
    "id": 93,
    "text": "Haunter"
  },
  {
    "id": 94,
    "text": "Gengar"
  },
  {
    "id": 95,
    "text": "Onix"
  },
  {
    "id": 96,
    "text": "Drowzee"
  },
  {
    "id": 97,
    "text": "Hypno"
  },
  {
    "id": 98,
    "text": "Krabby"
  },
  {
    "id": 99,
    "text": "Kingler"
  },
  {
    "id": 100,
    "text": "Voltorb"
  },
  {
    "id": 101,
    "text": "Electrode"
  },
  {
    "id": 102,
    "text": "Exeggcute"
  },
  {
    "id": 103,
    "text": "Exeggutor"
  },
  {
    "id": 104,
    "text": "Cubone"
  },
  {
    "id": 105,
    "text": "Marowak"
  },
  {
    "id": 106,
    "text": "Hitmonlee"
  },
  {
    "id": 107,
    "text": "Hitmonchan"
  },
  {
    "id": 108,
    "text": "Lickitung"
  },
  {
    "id": 109,
    "text": "Koffing"
  },
  {
    "id": 110,
    "text": "Weezing"
  },
  {
    "id": 111,
    "text": "Rhyhorn"
  },
  {
    "id": 112,
    "text": "Rhydon"
  },
  {
    "id": 113,
    "text": "Chansey"
  },
  {
    "id": 114,
    "text": "Tangela"
  },
  {
    "id": 115,
    "text": "Kangaskhan"
  },
  {
    "id": 116,
    "text": "Horsea"
  },
  {
    "id": 117,
    "text": "Seadra"
  },
  {
    "id": 118,
    "text": "Goldeen"
  },
  {
    "id": 119,
    "text": "Seaking"
  },
  {
    "id": 120,
    "text": "Staryu"
  },
  {
    "id": 121,
    "text": "Starmie"
  },
  {
    "id": 122,
    "text": "Mr. Mime"
  },
  {
    "id": 123,
    "text": "Scyther"
  },
  {
    "id": 124,
    "text": "Jynx"
  },
  {
    "id": 125,
    "text": "Electabuzz"
  },
  {
    "id": 126,
    "text": "Magmar"
  },
  {
    "id": 127,
    "text": "Pinsir"
  },
  {
    "id": 128,
    "text": "Tauros"
  },
  {
    "id": 129,
    "text": "Magikarp"
  },
  {
    "id": 130,
    "text": "Gyarados"
  },
  {
    "id": 131,
    "text": "Lapras"
  },
  {
    "id": 132,
    "text": "Ditto"
  },
  {
    "id": 133,
    "text": "Eevee"
  },
  {
    "id": 134,
    "text": "Vaporeon"
  },
  {
    "id": 135,
    "text": "Jolteon"
  },
  {
    "id": 136,
    "text": "Flareon"
  },
  {
    "id": 137,
    "text": "Porygon"
  },
  {
    "id": 138,
    "text": "Omanyte"
  },
  {
    "id": 139,
    "text": "Omastar"
  },
  {
    "id": 140,
    "text": "Kabuto"
  },
  {
    "id": 141,
    "text": "Kabutops"
  },
  {
    "id": 142,
    "text": "Aerodactyl"
  },
  {
    "id": 143,
    "text": "Snorlax"
  },
  {
    "id": 144,
    "text": "Articuno"
  },
  {
    "id": 145,
    "text": "Zapdos"
  },
  {
    "id": 146,
    "text": "Moltres"
  },
  {
    "id": 147,
    "text": "Dratini"
  },
  {
    "id": 148,
    "text": "Dragonair"
  },
  {
    "id": 149,
    "text": "Dragonite"
  },
  {
    "id": 150,
    "text": "Mewtwo"
  },
  {
    "id": 151,
    "text": "Mew"
  }
]

var commonMarkers = []
var uncommonMarkers = []
var rareMarkers = []
var veryRareMarkers = []
var ultraRareMarkers = []
var commonID = []
var uncommonID = []
var rareID = []
var veryRareID = []
var ultraRareID = []
var notifiedPokemon = []
var commonToggle
var uncommonToggle
var rareToggle
var veryRareToggle
var ultraRareToggle
var hidePokemon = [16,19]
var notifPokemon = []
var notifyIV
var setIconSize

var pokeMoves
var pokeNames
$.getJSON('pokemon.json', function(data) {
  pokeNames = data
})
$.getJSON('moves.json',function(data) {
  pokeMoves = data
})


console.log(store.enabled)
if (store.enabled) {
  initializeVariables()
}
else {
  commonToggle = false
  uncommonToggle = false
  rareToggle = true
  veryRareToggle = true
  ultraRareToggle = true
  $('#rareToggle').bootstrapToggle('on')
  $('#veryRareToggle').bootstrapToggle('on')
  $('#ultraRareToggle').bootstrapToggle('on')

}

$.fn.select2.amd.require(['select2/compat/matcher','select2/selection/search'], function (oldMatcher, Search) {
  var oldRemoveChoice = Search.prototype.searchRemoveChoice;

  Search.prototype.searchRemoveChoice = function () {
      oldRemoveChoice.apply(this, arguments);
      this.$search.val('');
  };
  $('#pokeHide').select2({
    data: pokemonNames,
    matcher: oldMatcher(matchStart),
    templateResult: formatPoke
  })
  $("#pokeHide").select2().val(hidePokemon).trigger('change')
  $('#pokeNotify').select2({
    data: pokemonNames,
    matcher: oldMatcher(matchStart),
    templateResult: formatPoke
  })
  $("#pokeNotify").select2().val(notifPokemon).trigger('change')
})

$('#pokeHide').on('select2:select', function(evt) {
  if ($.inArray(evt.params.data.id,hidePokemon) == -1) {
    hidePokemon.push(parseInt(evt.params.data.id))
  }
  if (store.enabled) {
    store.set('hidePokemon', hidePokemon)
  }
})
$('#pokeHide').on('select2:unselect', function(evt) {
  index = hidePokemon.indexOf(evt.params.data.id)
  hidePokemon.splice(index, 1)
  if (store.enabled) {
    store.set('hidePokemon', hidePokemon)
  }
})

$('#pokeNotify').on('select2:select', function(evt) {
  if ($.inArray(evt.params.data.id,notifPokemon) == -1) {
    notifPokemon.push(parseInt(evt.params.data.id))
  }
  if (store.enabled) {
    store.set('notifPokemon', notifPokemon)
  }
})
$('#pokeNotify').on('select2:unselect', function(evt) {
  index = notifPokemon.indexOf(evt.params.data.id)
  notifPokemon.splice(index, 1)
  if (store.enabled) {
    store.set('notifPokemon', notifPokemon)
  }
})

L.Map = L.Map.extend({
    openPopup: function (popup, latlng, options) {
		if (!(popup instanceof L.Popup)) {
			popup = new L.Popup(options).setContent(popup);
		}

		if (latlng) {
			popup.setLatLng(latlng);
		}

		if (this.hasLayer(popup)) {
			return this;
		}

		// if (this._popup && this._popup.options.autoClose) {
		// 	this.closePopup();
		// }

		this._popup = popup;
		return this.addLayer(popup);
	},
}); /***  end of hack ***/

map = L.map('map',{minZoom:3, tap: true, worldCopyJump: true});
var mapboxTiles = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png').addTo(map)
// var mapboxTiles = L.tileLayer('https://api.mapbox.com/styles/v1/mapbox/streets-v10/tiles/256/{z}/{x}/{y}?access_token=pk.eyJ1IjoiYW50aXJlbXkiLCJhIjoiY2lvZDEybHRjMDRnNXZna3FwbnU0YnRtayJ9.9HABMQncB67Fa8P7ibwTBA', {
// token: 'pk.eyJ1IjoiYW50aXJlbXkiLCJhIjoiY2lvZDEybHRjMDRnNXZna3FwbnU0YnRtayJ9.9HABMQncB67Fa8P7ibwTBA'
// }).addTo(map);
map.on('load', function(e){search()});
map.setView([36.50963615733049, -97.00927734375001], 5);
map.on('zoomend dragend',function(e){search();});
map.zoomControl.setPosition('bottomright');
var markerIcon = L.icon({
  iconUrl: 'images/myLocSmall.png',
  iconSize: [24,35]
})
var searchMarker = L.marker([0,0],{icon: markerIcon, zIndexOffset:999}).addTo(map);
new L.Control.GPlaceAutocomplete({
  position: "topright",
  callback: function(location) {
    var latlng = L.latLng([location['geometry']['location'].lat(),location['geometry']['location'].lng()])
    map.setView(latlng,14)
    searchMarker.setLatLng(latlng)
    search()
  }
})
.addTo(map);


window.setInterval(search, 1000)
var sidebar = L.control.sidebar('sidebar').addTo(map);
var common = new L.LayerGroup()
var uncommon = new L.LayerGroup()
var rare = new L.LayerGroup()
var veryRare = new L.LayerGroup()
var ultraRare = new L.LayerGroup()
var clusters = L.markerClusterGroup({
chunkedLoading: true,
spiderfyOnMaxZoom: false,
showCoverageOnHover: true,
iconCreateFunction: function(cluster) {
    //Grouping the cluster returned by the server, if
    var markers = cluster.getAllChildMarkers();
    var markerCount = 0;
    markers.forEach(function(m){markerCount = markerCount + m.count;});

    return new L.DivIcon({ html: '<div class=" clustergroup0 leaflet-marker-icon marker-cluster marker-cluster-medium leaflet-zoom-animated leaflet-clickable" tabindex="0" style="margin-left: -20px; margin-top: -20px; width: 40px; height: 40px; z-index: 233;"><div><span>'+markerCount+'</span></div></div>' });
    }
});

map.addLayer(clusters)
map.addLayer(common)
map.addLayer(uncommon)
map.addLayer(rare)
map.addLayer(veryRare)
map.addLayer(ultraRare)
/* This will add all the clusters as returned by the elastic server.*/
function getLocation() {
  if ("geolocation" in navigator) {
      navigator.geolocation.getCurrentPosition(showPosition);
  } else {
      console.log("Geolocation is not supported by this browser.");
  }
}
function showPosition(position) {
    map.setView([position.coords.latitude,position.coords.longitude],14);
    searchMarker.setLatLng([position.coords.latitude,position.coords.longitude])
}
function makeClusters(aggs){
    var markerList = [];
    aggs.forEach(function(agg, index){
        var center = geohash.decode (agg.key);//elastic return a geohas so need to change it into lat/lon
        var myIcon = L.divIcon({ html: '<div class="clustergroup0 leaflet-marker-icon marker-cluster marker-cluster-medium leaflet-zoom-animated leaflet-clickable" tabindex="0" style="margin-left: -20px; margin-top: -20px; width: 40px; height: 40px; z-index: 233;"><div><span>'+agg.doc_count+'</span></div></div>' });
        var marker = L.marker(new L.LatLng(center.latitude, center.longitude),{icon:myIcon});
        marker.count = agg.doc_count;
        marker.on('click', function(x) {
          map.setView([x['latlng']['lat'],x['latlng']['lng']],map.getZoom()+3)
          search()
        })
        //marker.sentiment = agg.sentiment_avg.value;
        markerList.push(marker);
    });
    //console.log(markerList)
    clusters.addLayers(markerList);
}
var iOS = /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
function makePokemon(pokemon){
  var markerList = [];
  pokemon.forEach(function(poke,index) {
    var info = poke['_source']
    //console.log(info)
    var location = info['location']
    var pokeID = info['pokemon_id']
    var encID = poke['_id']
    var dt = info['disappearTime']
    var attack = info['iv_attack']
    var defense = info['iv_defense']
    var stamina = info['iv_stamina']
    var move1
    var move2
    if (info['move_1'] != undefined) {
      move1 = pokeMoves[info['move_1']]['name']
      move2 = pokeMoves[info['move_2']]['name']
    }
    var iv = Math.round((attack+defense+stamina)*1000/45.0)/10
    var name = pokeNames[pokeID]['name']

    if ($.inArray(pokeID,hidePokemon) > -1) {
      if (commonID.includes(encID)) {
        index = commonID.indexOf(encID)
        commonID.splice(index, 1)
        common.removeLayer(commonMarkers[index])
        commonMarkers.splice(index,1)
      }
      else if (uncommonID.includes(encID)) {
        index = uncommonID.indexOf(encID)
        uncommonID.splice(index, 1)
        uncommon.removeLayer(uncommonMarkers[index])
        uncommonMarkers.splice(index,1)
      }
      else if (rareID.includes(encID)) {
        index = rareID.indexOf(encID)
        rareID.splice(index, 1)
        rare.removeLayer(rareMarkers[index])
        rareMarkers.splice(index,1)
      }
      else if (veryRareID.includes(encID)) {
        index = veryRareID.indexOf(encID)
        veryRareID.splice(index, 1)
        veryRare.removeLayer(veryRareMarkers[index])
        veryRareMarkers.splice(index,1)
      }
      else if (ultraRareID.includes(encID)) {
        index = ultraRareID.indexOf(encID)
        ultraRareID.splice(index, 1)
        ultraRare.removeLayer(ultraRareMarkers[index])
        ultraRareMarkes.splice(index,1)
      }
      return true
    }

    var icon = L.icon ({
      iconUrl: 'icons/' + pokeID +'.png',
      iconSize: [$("#iconSize").val(),$("#iconSize").val()]
    })
    var popup
    if (attack != null) {
      popup = L.popup()
        .setContent('<strong>'+name+'</strong> - ' + pokeNames[pokeID]['rarity'] +
        '<br><span class="label-countdown" disappears-at=\'' + dt + '\'>' + getTimeRemaining(dt, "string") + '</span><br><strong>IV: ' + iv
        + '% (' + attack + '/' + defense + '/' + stamina + ')</strong><br>'
        + 'Moves: ' + move1 + ' / ' + move2)
    }
    else {
      popup = L.popup()
        .setContent('<strong>'+name+'</strong> - ' + pokeNames[pokeID]['rarity'] +
        '<br><span class="label-countdown" disappears-at=\'' + dt + '\'>' + getTimeRemaining(dt, "string") + '</span>')
    }
    var marker = L.marker([location['lat'],location['lon']],{icon: icon})
    .bindPopup(popup)
    marker['disappearTime'] = moment(dt)
    var mouseOut = true
    marker.on('mouseover', function (e) {
      this.openPopup();
    });
    marker.on('click', function (e) {
      this.openPopup()
      mouseOut = false
    });
    marker.on('mouseout', function (e) {
      if (mouseOut){
        this.closePopup();
      }
    });
    marker.on('popupclose', function(e) {
      if (!mouseOut) {
        mouseOut = true
      }
    })
    if (Date.parse(dt) > Date.now()) {
      if (pokeNames[pokeID]['rarity'] == 'Common' && !commonID.includes(encID) && commonToggle) {
        marker.addTo(common)
        commonID.push(encID)
        commonMarkers.push(marker)
      }
      else if (pokeNames[pokeID]['rarity'] == 'Uncommon' && !uncommonID.includes(encID) && uncommonToggle) {
        marker.addTo(uncommon)
        uncommonID.push(encID)
        uncommonMarkers.push(marker)
      }
      else if (pokeNames[pokeID]['rarity'] == 'Rare' && !rareID.includes(encID) && rareToggle) {
        marker.addTo(rare)
        rareID.push(encID)
        rareMarkers.push(marker)
      }
      else if (pokeNames[pokeID]['rarity'] == 'Very Rare' && !veryRareID.includes(encID) && veryRareToggle) {
        marker.addTo(veryRare)
        veryRareID.push(encID)
        veryRareMarkers.push(marker)
      }
      else if (pokeNames[pokeID]['rarity'] == 'ultraRare' && !ultraRareID.includes(encID) && ultraRareToggle) {
        marker.addTo(ultraRare)
        ultraRareID.push(encID)
        ultraRareMarkers.push(marker)
      }
    }
    if (notifyIV != "" && iv>=notifyIV && !notifiedPokemon.includes(encID) && !iOS) {
      notifiedPokemon.push(encID)
      marker.setZIndexOffset(1000)
      Push.create("High IV Pokémon!", {
        body: "Found a " + iv + "% " + name,
        icon: "pixel_icons/" + pokeID + ".png",
        timeout: 4000,
        onClick: function() {
          window.focus()
          map.setView([location['lat'],location['lon']], 15)
        }
      })
      marker.bounce(15)
    }
    else if (notifPokemon.includes(pokeID) && !notifiedPokemon.includes(encID) && !iOS) {
      notifiedPokemon.push(encID)
      marker.setZIndexOffset(1000)
      Push.create("Found a special Pokémon!", {
        body: "Found a " + iv + "% " + name,
        icon: "pixel_icons/" + pokeID + ".png",
        timeout: 4000,
        onClick: function() {
          window.focus()
          map.setView([location['lat'],location['lon']], 15)
        }
      })
      if (map.hasLayer(marker)) {
        marker.bounce(15)
      }
    }
  })
}

function search() {
  $('.label-countdown').each(function (index, element) {
    $(element).text(getTimeRemaining(element.getAttribute('disappears-at'), "string"))
  })

  for (marker in commonMarkers) {
    if (moment(commonMarkers[marker]['disappearTime']).isBefore(moment())) {
      common.removeLayer(commonMarkers[marker])
      commonMarkers.splice(marker,1)
      commonID.splice(marker,1)
    }
  }
  for (marker in uncommonMarkers) {
    if (moment(uncommonMarkers[marker]['disappearTime']).isBefore(moment())) {
      uncommon.removeLayer(uncommonMarkers[marker])
      uncommonMarkers.splice(marker,1)
      uncommonID.splice(marker,1)
    }
  }
  for (marker in rareMarkers) {
    if (moment(rareMarkers[marker]['disappearTime']).isBefore(moment())) {
      rare.removeLayer(rareMarkers[marker])
      rareMarkers.splice(marker,1)
      rareID.splice(marker,1)
    }
  }
  for (marker in veryRareMarkers) {
    if (moment(veryRareMarkers[marker]['disappearTime']).isBefore(moment())) {
      veryRare.removeLayer(veryRareMarkers[marker])
      veryRareMarkers.splice(marker,1)
      veryRareMarkers.splice(marker,1)
    }
  }
  for (marker in ultraRareMarkers) {
    if (moment(ultraRareMarkers[marker]['disappearTime']).isBefore(moment())) {
      ultraRare.removeLayer(ultraRareMarkers[marker])
      ultraRareMarkers.splice(marker,1)
      ultraRareID.splice(marker,1)
    }
  }
  var b = map.getBounds();
  var b1 = {
      "nwlat": b.getNorthWest().lat % 90,
      "nwlon": b.getNorthWest().lng % 180,
      "selat": b.getSouthEast().lat % 90,
      "selon": b.getSouthEast().lng % 180
  }
  //Get the zoom level
  var zoom = 3;
  if(map.getZoom() >= 5 && map.getZoom() <= 8){
      zoom =4;
  }
  else if(map.getZoom() >= 9 && map.getZoom() <= 11){
      zoom =5;
  }
  else if(map.getZoom() >= 12 && map.getZoom() <= 14){
      zoom =6;
  }
  else if(map.getZoom() >= 15 && map.getZoom() <= 17){
      zoom =7;
  }
  else if(map.getZoom() >= 18){
      zoom =8;
  }
  var dataString = "northWestLat=" +  b1.nwlat +
  "&northWestLng=" + b1.nwlon +
  "&southEastLat=" + b1.selat +
  "&southEastLng=" + b1.selon +
  "&zoom=" + zoom
  if (map.getZoom() < 14) {
    $.ajax({
      type : "POST",
      url : "clusterGrab.php",
      data: dataString,
      cache: false,
      success: function(resp) {
        //console.log(resp)
        if (resp.startsWith("Error:")) {
          console.log(resp)
        }
        else {
          clearAllPokemon()
          var result = JSON.parse(resp)
          makeClusters(result.aggregations.zoom.buckets)
        }
      }
    })
  }
  else {
    if (commonToggle == true) {
      $.ajax({
        type : "POST",
        url : "pokeGrabCommon.php",
        data: dataString,
        cache: false,
        success: function(resp) {
          clusters.clearLayers();
          // common.clearLayers();
          if (resp.startsWith("Error:")) {
            console.log(resp)
          }
          var result = JSON.parse(resp)
          makePokemon(result['hits']['hits'])
        }
      })
    }
    if (uncommonToggle == true) {
      $.ajax({
        type : "POST",
        url : "pokeGrabUncommon.php",
        data: dataString,
        cache: false,
        success: function(resp) {
          clusters.clearLayers();
          // uncommon.clearLayers();
          if (resp.startsWith("Error:")) {
            console.log(resp)
          }
          var result = JSON.parse(resp)
          makePokemon(result['hits']['hits'])
        }
      })
    }
    if (rareToggle == true) {
      $.ajax({
        type : "POST",
        url : "pokeGrabRare.php",
        data: dataString,
        cache: false,
        success: function(resp) {
          clusters.clearLayers();
          // rare.clearLayers();
          if (resp.startsWith("Error:")) {
            console.log(resp)
          }
          var result = JSON.parse(resp)
          makePokemon(result['hits']['hits'])
        }
      })
    }
    if (veryRareToggle == true) {
      $.ajax({
        type : "POST",
        url : "pokeGrabVeryRare.php",
        data: dataString,
        cache: false,
        success: function(resp) {
          clusters.clearLayers();
          // veryRare.clearLayers();
          if (resp.startsWith("Error:")) {
            console.log(resp)
          }
          var result = JSON.parse(resp)
          makePokemon(result['hits']['hits'])
        }
      })
    }
    if (ultraRareToggle == true) {
      $.ajax({
        type : "POST",
        url : "pokeGrabUltraRare.php",
        data: dataString,
        cache: false,
        success: function(resp) {
          clusters.clearLayers();
          // ultraRare.clearLayers();
          if (resp.startsWith("Error:")) {
            console.log(resp)
          }
          var result = JSON.parse(resp)
          makePokemon(result['hits']['hits'])
        }
      })
    }
  }
}

function pad(n) {
    return (n < 10) ? ("0" + n) : n;
}

function matchStart (term, text) {
  if (text.toUpperCase().indexOf(term.toUpperCase()) == 0) {
    return true;
  }

  return false;
}

function clearAllPokemon () {
  clusters.clearLayers()
  common.clearLayers()
  uncommon.clearLayers()
  rare.clearLayers()
  veryRare.clearLayers()
  ultraRare.clearLayers()
  commonMarkers = []
  uncommonMarkers = []
  rareMarkers = []
  veryRareMarkers = []
  ultraRareMarkers = []
  commonID = []
  uncommonID = []
  rareID = []
  veryRareID = []
  ultraRareID = []
}

function formatPoke (poke) {
  if (!poke.id) { return poke.text; }
  var $poke = $(
    '<span><img src="pixel_icons/' + poke.id + '.png" class="img-flag" /> ' + poke.text + '</span>'
  );
  return $poke;
};

function getTimeRemaining(endtime, returnType){
  // console.log(new Date(endtime))
  // console.log(new Date())
  var t = Date.parse(endtime) - Date.parse(new Date());
  var seconds = Math.floor( (t/1000) % 60 );
  var minutes = Math.floor( (t/1000/60) % 60 );
  var hours = Math.floor( (t/(1000*60*60)) % 24 );
  var days = Math.floor( t/(1000*60*60*24) );
  if (returnType == "string") {
    return 'Disappears in ' + pad(minutes) + 'm' + pad(seconds) + 's'
  }
  else if (returnType == "digits") {
    return {
        'total': t,
        'days': days,
        'hours': hours,
        'minutes': minutes,
        'seconds': seconds
      };
  }
}

function initializeVariables() {
  if (store.get('iconSize') != undefined) {
    $("#iconSize").val(store.get('iconSize'))
    $("#sizeVal").text(store.get('iconSize'))
  }
  if (store.get('notifyIV') == undefined) {
    store.set('notifyIV', "")
  }
  else {
    notifyIV = store.get('notifyIV')
    $("#notifyIV").val(notifyIV)
  }
  if (store.get('hidePokemon') == undefined) {
    store.set('hidePokemon', hidePokemon)
  }
  else {
    hidePokemon = store.get('hidePokemon')
  }
  if (store.get('notifPokemon') != undefined) {
    notifPokemon = store.get('notifPokemon')
  }
  if (store.get('common') == undefined) {
    store.set('common', false)
    commonToggle = false
  }
  else {
    commonToggle = Boolean(store.get('common'))
    if (commonToggle) {
      $('#commonToggle').bootstrapToggle('on')
    }
  }
  if (store.get('uncommon') == undefined) {
    store.set('uncommon', false)
    uncommonToggle = false
  }
  else {
    uncommonToggle = Boolean(store.get('uncommon'))
    if (uncommonToggle) {
      $('#uncommonToggle').bootstrapToggle('on')
    }
  }
  if (store.get('rare') == undefined) {
    $('#rareToggle').bootstrapToggle('on')
    store.set('rare', true)
    rareToggle = true
  }
  else {
    rareToggle = Boolean(store.get('rare'))
    if (rareToggle) {
      $('#rareToggle').bootstrapToggle('on')
    }
  }
  if (store.get('veryrare') == undefined) {
    $('#veryRareToggle').bootstrapToggle('on')
    store.set('veryrare', true)
    veryRareToggle = true
  }
  else {
    veryRareToggle = Boolean(store.get('veryrare'))
    if (veryRareToggle) {
      $('#veryRareToggle').bootstrapToggle('on')
    }
  }
  if (store.get('ultrare') == undefined) {
    $('#ultraRareToggle').bootstrapToggle('on')
    store.set('ultrarare', true)
    ultraRareToggle = true
  }
  else {
    ultraRareToggle = Boolean(store.get('ultrarare'))
    if (ultraRareToggle) {
      $('#ultraRareToggle').bootstrapToggle('on')
    }
  }
}

$('#location').on('click', function() {
  if ($('#location').parent('li').hasClass('active')) {
    $('#location').parent('li').removeClass('active')
  }
  else {
    getLocation()
    $('#location').parent('li').addClass('active')
  }
})

$('#notifyIV').change(function() {
  notifyIV = $('#notifyIV').val()
  if (store.enabled) {
    store.set('notifyIV', notifyIV)
  }
})
$('#commonToggle').change(function() {
  commonToggle = !commonToggle
  if (store.enabled) {
    store.set('common', commonToggle)
  }
  common.clearLayers();
  commonMarkers = []
  commonID = []
  search()
})
$('#uncommonToggle').change(function() {
  uncommonToggle = !uncommonToggle
  if(store.enabled) {
    store.set('uncommon', uncommonToggle)
  }
  uncommon.clearLayers();
  uncommonMarkers = []
  uncommonID = []
  search()
})
$('#rareToggle').change(function() {
  rareToggle = !rareToggle
  if (store.enabled) {
    store.set('rare', rareToggle)
  }
  rare.clearLayers();
  rareMarkers = []
  rareID = []
  search()
})
$('#veryRareToggle').change(function() {
  veryRareToggle = !veryRareToggle
  if (store.enabled) {
    store.set('veryrare', veryRareToggle)
  }
  veryRare.clearLayers()
  veryRareMarkers = []
  veryRareID = []
  search()
})
$('#ultraRareToggle').change(function() {
  ultraRareToggle = !ultraRareToggle
  if (store.enabled) {
    store.set('ultrarare', commonToggle)
  }
  ultraRare.clearLayers();
  ultraRareMarkers = []
  ultraRareID = []
  search()
})
$('#iconSize').change(function() {
  val = $("#iconSize").val()
  $("#sizeVal").text(val)
  clearAllPokemon()
  if (store.enabled) {
    store.set('iconSize', val)
  }
})
